# 系统架构设计

## 一、系统概述

本系统基于大模型的迭代反思技术，旨在自动化回复大学硕士生的咨询邮件。系统的核心功能包括语义解析、迭代式回复规划和自动化回复生成，通过多轮反馈和质量评估不断优化回复内容。

---

## 二、总体架构

![系统架构图](#) _(这个还没有找到合适的工具,打算最近尽快找到合适的工作画出架构图,然后模块化各部分内容)_

> 斜体表示不一定要实现的功能,或者现阶段不计划实现的功能。

---

## 三、核心模块的设计

> 整体打算采用 Node.js 和 Python 混合开发,Node.js 负责构建 Web 服务以及消息中间件,Python 负责 AI 识别和生成,具体的技术栈和模块设计如下:

### 1. 邮件接收模块

- **邮件抓取：**
  - 使用 `imap-simple` 或 `node-imap` 库来连接 IMAP 邮件服务器，从邮箱中获取新邮件。
  - **Node.js** 自带的 `mailparser` 库，可以用于解析邮件的头部、正文和附件。
- **预处理：**

  - 使用 `html-to-text` 库将邮件的 HTML 内容转换为纯文本，以便后续处理。

-

### 2. 语义解析与用户画像识别模块

- **用户画像构建：** 从邮件文本中提取用户的基本信息，如姓名、申请专业、背景等，建立用户画像,通过半结构化的方式(如 Json)存储到数据库(目前暂时考虑 MongoDB,比较简单)或者缓存(需要进一步调研)。
- **需求识别：** 使用大语言模型分析邮件中的意图和需求，如咨询问题、申请状态查询等,这个主要使用大模型和提示词工程来实现。

### 3. 回复生成与迭代反思模块

**功能：**

- **回复生成：**

  - 基于大语言模型,结合提示词来生成复合预定回复模式的回复,确保回复内容准确、专业。
    - 需要维护一个政策信息的数据库,用于回复生成时的参考,或者进行提示词训练,有两种方案
      - 自然语言识别+硬性回答: 即先用大模型识别用户意图,然后完全参考根据政策信息库进行回答
      - 自然语言识别+软性回答: 即先用大模型识别用户意图,然后根据政策信息库进行提示词训练,调用大模型进行回答
  - 从实现提取的用户画像的半结构化信息来实现个性化回复。

- **多轮对话管理：**

  - 业务场景中,可能会出现多次连续邮件沟通的情况,系统需要能够保持上下文，在多轮交互中生成连贯的回复，提升用户体验(这里计划先使用持久化存储来实现,也有可能使用缓存技术,我需要进一步调研一下)。

- **迭代反思：**
  - 生成回复后，通过反思机制对回复进行质量评估，判断其准确性、完整性和语气。如果检测到问题，进行自动化的修改和优化,这个主要是用大模型自我识别,进行语言、情感分析等来实现。
    - 参考 MetaGPT,一种可能的解决方案是多智能体协作
    - 例如一个智能体 A 负责写内容,另一个智能体 B 负则审核,两个智能体共享一个 global 的信息池,
    - A 生成的内容会被 B 审核,B 会对邮件内容进行质量评估(通过大模型实现),形成纠错与改进建议
    - A 会根据 B 的建议进行修改,然后再次提交给 B 审核,直到 B 审核通过
    - 这样的方案会增加系统的复杂度,并且需要平衡的成本和效益,需要进一步调研。
    - 这种方案还能解决另一个实际问题,就是邮件内容审核问题
  - 评估是否需要对回复进行二次生成或调整。

### 4. 邮件发送模块

**功能：**

- **邮件发送：** 负责将生成的回复邮件发送到用户的邮箱，确保邮件发送的安全性和稳定性。
- **发送状态跟踪：** 跟踪每封邮件的发送状态，记录成功发送或失败的邮件，支持重试机制。
- **日志记录：** 记录每次邮件发送的详细信息，包括时间、状态和异常情况。

**技术选型：**

- **使用 Node.js 实现：**

  - 使用 `nodemailer` 库来实现邮件的发送功能

- **发送状态管理：**

  - 对于发送失败的邮件，设置重试机制或标记为失败状态，以便后续处理。
  - 使用日志记录邮件发送结果，支持后续的监控和问题排查。

\*- **安全性：\***

- 通过 OAuth2 或其他加密协议，确保邮件传输过程中用户信息的安全。

---

_### 5. 日志与监控模块()_

---

## 四、数据流程

1. **邮件接收：** 系统定期从邮箱获取新邮件并进行预处理。
2. **语义解析：** 对邮件内容进行语义分析，提取用户意图和关键信息。
3. **用户画像更新：** 更新用户画像，根据用户信息和历史记录做个性化分析。
4. **迭代反思规划：** 根据用户需求和语义解析结果，规划最优回复。
5. **回复生成：** 根据规划生成具体的回复内容，并融合政策信息。
6. **质量评估：** 对生成的回复进行评估和优化，确保回复准确、合规。
7. **邮件发送：** 将最终的回复邮件发送给用户，并记录日志。

---

## 五、技术栈汇总

- **编程语言：** Python, Node.js
- **框架与库：**
  - **邮件处理：**
  - **Web 框架：** Express.js, Flask
  - **数据库：** MySQL、MongoDB
  - **日志与监控：**
- **外部服务：**
  - 大语言模型(待定)

---

## 六、安全与隐私

- 需要特别注意的是用户(学生)个人信息的隐私权问题,这个需要提前调研,并且在设计和实现中充分考虑。

---

## 七、部署方案(待定)

---
